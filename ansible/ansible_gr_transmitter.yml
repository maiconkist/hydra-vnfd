- hosts: transmitters
  vars:
    hydraServer: 192.168.5.54
  remote_user: ubuntu
  tasks:
    - name: Install dependencies
      apt:
        name: "{{ packages }}"
      vars:
        packages:
          - libzmq3-dev
          - libfftw3-dev
          - libopencv-dev
          - gnuradio
          - gnuradio-dev
      become: yes

    - name: Get source for GR-Hydra
      git:
        repo: "https://github.com/maiconkist/gr-hydra.git"
        dest: /home/ubuntu/gr-hydra
        version: bleeding
        update: true
        force: yes
    
    - name: Make HyDRA Directory
      file:
        path: /home/ubuntu/gr-hydra/build
        state: directory
    - name: CMake HyDRA
      command: cmake ../
      args:
        chdir: /home/ubuntu/gr-hydra/build
    - make:
        chdir: /home/ubuntu/gr-hydra/build
    - make:
        chdir: /home/ubuntu/gr-hydra/build
        target: install
      become: yes
    
    - name: Make GRC-HyDRA Directory
      file:
        path: /home/ubuntu/gr-hydra/grc_blocks/build
        state: directory
    - name: CMake HyDRA
      command: cmake ../
      args:
        chdir: /home/ubuntu/gr-hydra/grc_blocks/build
    - make:
        chdir: /home/ubuntu/gr-hydra/grc_blocks/build
    - make:
        chdir: /home/ubuntu/gr-hydra/grc_blocks/build
        target: install
      become: yes
  
    - name: Replacing hydraServer IP
      replace:
        dest: /home/ubuntu/gr-hydra/grc_blocks/app/ansible_hydra_gr_client_2tx_2rx.py
        regexp: "hydraServerIP"
        replace: "{{ hydraServer }}"
  
    - name: Replacing hydraClientIP
      replace:
        dest: /home/ubuntu/gr-hydra/grc_blocks/app/ansible_hydra_gr_client_2tx_2rx.py
        regexp: "hydraClientIP"
        replace: "{{ hostvars[inventory_hostname]['ansible_default_ipv4']['address'] }}"

    - name: chmod  /home/ubuntu/gr-hydra/grc_blocks/app/ansible_hydra_gr_client_2tx_2rx.py
      file:
        path: /home/ubuntu/gr-hydra/grc_blocks/app/ansible_hydra_gr_client_2tx_2rx.py
        state: file
        mode: a+x
      
    - name: Start ansible_hydra_gr_client_2tx_2rx.py script. Log to /tmp/
      shell: "(nohup python /home/ubuntu/gr-hydra/grc_blocks/app/ansible_hydra_gr_client_2tx_2rx.py </dev/null > /tmp/ansible_hydra_gr_client_2tx_2rx.log 2>&1 &)"
